# M4：安全でない認証

| <center>脅威エージェント</center> | <center>攻撃経路</center> | <center>セキュリティ上の弱点</center> || <center>技術的な影響</center> | <center>ビジネスへの影響</center> |
| -- | -- | -- | -- | -- | -- |
| <center>アプリケーション依存</center> | <center>攻撃難易度：容易</center> | <center>普及度：中</center> | <center>検出難易度：普通</center> | <center>深刻な影響</center> | <center>アプリケーション/ビジネス依存</center> |
| 認証の脆弱性を悪用する脅威エージェントは、利用可能なまたはカスタムされたツールを使用して自動化された攻撃を実行します。 | 攻撃者が一旦、認証スキームに脆弱性があると知ってしまうと、モバイルアプリのバックエンドサーバにサービスリクエストを送信することにより、認証を偽装したり回避したりします。そして、モバイルアプリとの直接的なやり取りを回避します。この送信プロセスは、デバイス内のモバイルマルウェアや攻撃者が所有しているボットネットを通して行われます。 | 認証スキームの不備もしくは欠如は、モバイルアプリで利用しているモバイルアプリやバックエンドサーバ内の機能を、攻撃者が匿名で実行することを許可することになります。モバイルデバイスの入力フォームが要因として、モバイルアプリの認証は脆弱であることがよく見られます。このフォームによる要因は、4桁のPINに基づいた短いパスワード使用を助長しています。 <br> モバイルアプリの認証要件は、可用性要件のために、従来のWeb認証スキームとはかなり異なります。 <br> 従来のWebアプリでは、ユーザはオンラインでバックエンドサーバとリアルタイムで認証することが期待されます。それらのセッションを通して、ユーザはインターネットへの持続的なアクセスを維持できるという期待があります。 <br> モバイルアプリでは、セッション期間中、ユーザは常にオンラインであることは期待されていません。モバイルインターネット接続は、従来のWeb接続と比べてはるかに信頼性が低く、予測可能性が低いです。したがって、モバイルアプリにはオフライン認証を必要とするアップタイム要件があります。このオフライン要件は、モバイル認証を実装する時に開発者が考慮しないといけない事に大きな影響を与えています。 <br> 認証スキームの不備を検出するために、テスターはアプリが「オフライン」モードのときに、モバイルアプリに対してバイナリ攻撃を実行できます。その攻撃では、テスターはアプリのオフライン認証を回避し、それからオフライン認証が要求される機能を実行します(バイナリ攻撃についての詳細はM10を参照)。 同様に、テスターはモバイルアプリの機能に関するPOST/GETリクエストからセッショントークンを削除して、バックエンドサーバの機能を匿名で実行できるか試してみるべきです。 || 認証不備の技術的な影響は、ソリューションがあるアクションへのリクエストを実行しているユーザを識別できないことです。ユーザ識別が確立できないため、ソリューションはユーザアクティビティの記録や監査が即座にできなくなるでしょう。これにより、攻撃元や潜在的な攻撃の性質や、将来の攻撃を防ぐ方法を見つけることができなくなります。認証の不備は潜在的な認証の不備を暴露するかもしれません。認証制御が機能しないとき、ソリューションはユーザ識別の妥当性を検証できません。このユーザ識別はユーザの役割と関連付けられたパーミッションにリンクしています。もし攻撃者が重要な機能を匿名で実行できたのなら、それはアクションを要求するリクエストを発行したユーザのパーミッションをコードが検証していないということを明らかにしています。したがって、匿名でのコード実行は認証と認可制御両方の不備を浮き彫りにします。 | 認証不備のビジネスへの影響は、少なくとも以下の結果をもたらすでしょう。 <br> - 風評被害 <br> - 情報の窃取 <br> - データへの不正アクセス |

## 脆弱性有無の確認
モバイルアプリには、安全でない認証の問題を抱える様々なケースがあります。

 - モバイルアプリがアクセストークンを送信することなく、バックエンドAPIサービスのリクエストを匿名で実行することができる場合、アプリケーションは安全でない認証の問題を抱えています。
 - モバイルアプリがパスワードや共通秘密鍵をデバイスのローカルに保存している場合、安全でない認証である可能性が高いです。
 - モバイルアプリがパスワード入力を簡略化するために脆弱なパスワードポリシーを設定している場合、安全でない認証の問題を抱えています。
 - モバイルアプリがTouchIDのような機能を使用している場合、安全でない認証の問題を抱えています。


## 防止方法
### 脆弱なパターンの回避
以下のような安全でないモバイルアプリケーション認証設計のパターンを避けてください。

 - Webアプリケーションをモバイル版に移植する場合、モバイルアプリケーションの認証要件は、Webアプリケーションコンポーネントの認証要件と一致すべきです。したがって、Webブラウザよりも少ない認証要素で認証できるようにすべきではありません。
 - ローカルでユーザ認証することは、クライアント側での認証回避につながります。アプリケーションがローカルにデータを保存している場合、ランタイム環境の操作やバイナリ改ざんによって、Jailbreakされたデバイス上で認証ルーチンが回避される可能性があります。もし、オフライン認証をせざる得ないビジネス要件がある場合、モバイルアプリに対するバイナリ攻撃を防ぐためにM10を参照すること。
 - 可能なら、全ての認証リクエストがサーバ側で実行されるようにすること。認証成功時に、アプリケーションデータがモバイルデバイスにロードされるようにすること。これにより、認証成功時にしか、アプリケーションデータが利用できなくなります。

 - クライアント側のデータ保存が必要な場合、ユーザのログイン認証情報から安全に生成された暗号鍵を用いて、データを暗号化する必要があります。これにより、正しい認証情報が入力された場合のみ、保存されているアプリケーションデータにアクセス可能となります。バイナリ攻撃によってデータが解読されるというさらなるリスクが存在します。ローカルデータの窃取につながるバイナリ攻撃を防ぐには、M9を参照すること。
 - モバイルアプリケーションで実装される永続的な認証(Remember Me)機能は、デバイス内にユーザのパスワードを決して保存してはいけません。
 - 理想的には、モバイルアプリケーションは、ユーザによってモバイルアプリケーションから取り消し可能なデバイス固有の認証トークンを利用すべきです。これにより、アプリが盗難されたもしくは紛失したデバイスからの不正アクセスを軽減することができます。
 - ユーザを認証するために、なりすまし可能な値を使用しないこと。デバイス識別子や地理位置情報を含みます。
 - モバイルアプリケーションでの永続的な認証はオプトインとして実装すべきであり、デフォルトでは有効にすべきではありません。
 - 可能なら、ユーザが4桁のPINコードを認証パスワードとして使用することを許可しないこと。

### 認証の強化
 - 開発者は、全てのクライアント側の認可と認証制御が悪意のあるユーザによって回避される可能性があるということを想定するべきです。出来る限りサーバ側で、認可と認証制御を再実施すべきです。
 - オフライン使用要件によって、モバイルアプリは、モバイルアプリコード内でローカル認証や認可チェックを要求されることがあります。その場合、開発者は不正にコード改ざんがされていないか検知するため、コード内でローカルの整合性チェックを実施する必要があります。バイナリ攻撃の検知と対応に関する情報はM9を参照してください。


## 攻撃シナリオの例
以下のシナリオは、モバイルアプリにおける脆弱な認証制御や認可制御を示しています。

**シナリオ #1：** 隠されたサービスリクエスト<br>
開発者は、モバイルアプリがバックエンドに送信するサービスリクエストは認証されたユーザだけが生成できると思い込んでいます。リクエスト処理時に、サーバ側のコードは受け取ったリクエストが既知のユーザと関連しているかどうかを検証しません。それゆえ、攻撃者はバックエンドサービスにサービスリクエストを送信し、本ソリューションの正規ユーザに影響を与える機能を匿名で実行します。

**シナリオ #2：** インターフェース依存<br>
開発者は、認証されたユーザだけがモバイルアプリ上の特定の機能を表示できると思い込んでいます。それゆえ、認証された正規のユーザのみがモバイルデバイスからそのサービスに対してリクエストを発行することができると考えます。リクエストを処理するバックエンドのコードは、そのリクエストに関連するIDがサービスを実行する許可を与えられているかどうか、わざわざ検証しません。それゆえ、攻撃者はかなり低い権限のユーザアカウントで、リモート管理機能を実行することができます。

**シナリオ #3：** ユーザビリティ要件<br>
ユーザビリティ要件が原因で、モバイルアプリは4桁のパスワードしか許可しません。サーバのコードはハッシュ化されたパスワードを保存します。しかしながら、ひどく短いパスワードのため、攻撃者はレインボーハッシュテーブルを用いてオリジナルのパスワードを素早く推測することが可能です。もし、サーバ上のパスワードファイル(もしくはデータストア)が漏えいすれば、攻撃者はユーザのパスワードを素早く推測できるでしょう。

## 参考資料
### OWASP
 - [こちらを参照](https://www.owasp.org/)

### その他 
 - [外部参照](http://cwe.mitre.org/)
