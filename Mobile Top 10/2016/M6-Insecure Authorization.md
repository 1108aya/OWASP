# M6：安全でない認可制御

<table>
 <tr>
  <th>脅威エージェント</th>
  <th>攻撃経路</th>
  <th colspan="2">セキュリティ上の弱点</th>
  <th>技術的な影響</th>
  <th>ビジネスへの影響</th>
 </tr>
 <tr>
  <td align="center" width="20%">アプリケーション依存 </td>
  <td align="center" width="15%">攻撃難易度<br>容易</td>
  <td align="center" width="15%">普及度<br>中</td>
  <td align="center" width="15%">検出難易度<br>普通</td>
  <td align="center" width="17.5%">影響度<br>重大</td>
  <td align="center" width="17.5%">アプリケーション / ビジネス依存</td>
 </tr>
 <tr>
  <td>認可制御の脆弱性を悪用する脅威エージェントは、利用可能なもしくはカスタムツールを使用して自動化された攻撃を行います。</td>
  <td>攻撃者は認可スキームがどのように脆弱なのかを理解したらすぐに、正規ユーザとしてアプリケーションにログインします。攻撃者は認証制御を通過します。認証を通り抜けるとすぐに、通常、攻撃者は管理者機能を実行するために、脆弱なエンドポイントを強制的に閲覧します。このサブミッションプロセスは通常、デバイス内のモバイルマルウェア、もしくは攻撃者が所有するボットネットを通して行われます。</td>
  <td colspan="2">認可スキームの不備をテストするために、テスターはモバイルアプリに対してバイナリ攻撃を実行したり、モバイルアプリが「オフライン」モードの間、より高い権限のユーザだけが実行できる特権機能を実行できるか試すことができます(バイナリ攻撃の詳細はM9、M10を参照)。同様に、テスターはバックエンドサーバへの機密機能に対するPOST/GETリクエスト内に含まれる低い権限のセッショントークンを用いて、特権機能を実行しようと試みるべきです。認可スキームの不備や欠如は、認証されているが低い権限のモバイルアプリのユーザを利用して、攻撃者が権限を有していない機能を実行することを許します。リモートサーバを通してではなく、モバイルデバイス内で認可決定を行う場合、認可要件はより脆弱になります。これはオフラインユーザビリティのモバイル要件が原因となっている要件によるかもしれません。</td>
  <td>認可不備の技術的影響は、認証不備の技術的影響と似た性質があります。技術的影響は、実際は広範囲に及ぶ可能性があり、権限を越えて実行される機能の性質に依存します。例えば、リモートやローカルからの権限を越える管理者機能の実行は、システムの破壊や機密情報へのアクセスといった結果につながります。</td>
  <td>ユーザ(匿名もしくは検証済)が権限を越える機能を実行することができる場合、ビジネスは以下の影響を受ける可能性があります。
   <ul>
    <li> 風評被害</li>
    <li> 詐欺</li>
    <li> 情報の窃取</li>
   </ul>
  </td>
 </tr>
</table>


## 脆弱性有無の確認
認証と認可の違いを認識することが重要です。認証は個人を識別する行為です。認可は識別された個人がその行為を実行するために必要な権限を持っているかをチェックする行為です。認証と認可は密接に関連しており、モバイルデバイスからのリクエストの認証の直後に、認可チェックは常に行われるべきです。

モバイルデバイスからリクエストされるAPIエンドポイントを実行する前に、もし組織が認証と識別を行っていない場合、そのコードは安全でない認証の影響を自動的に受けることになります。呼び出し元のアイデンティティーが確立されていない状態で、認可チェックが発生することは、本来不可能である。

モバイルエンドポイントが安全でない認可の影響を受けるかどうかを判断するには、以下のようないくつかの簡単なルールがあります。

 - **安全でない直接オブジェクト参照(IDOR)の脆弱性の存在 -** 安全でない直接オブジェクト参照(IDOR)があるのなら、コードは妥当な認可チェックを実行していない可能性が最も高いです。
 - **隠されたエンドポイント -** 一般的に開発者は、バックエンドの隠れた機能に対して認可チェックを実行しない。なぜなら隠れた機能は正しいロールの人のみにしか閲覧されないと想定しているからです。
 - **ユーザのロールや権限の送信 -** モバイルアプリがリクエストの一部としてバックエンドシステムにユーザのロールや権限を送信している場合、安全でない認可の影響を受けます。

## 防止方法
本リスクを回避するために、以下を実施してください。
 - バックエンドシステムの情報のみを用いて、認証されたユーザのロールと権限を検証する。モバイルデバイス自体から来るロールや権限の情報に頼ることを避ける。
 - バックエンドコードは、あるアイデンティティーに伴うリクエスト(要求された操作のオペランド)に紐づくあらゆる識別子が、アイデンティティーと一致しているか、そしてそれに属しているか、独立して検証するべきです。


## 攻撃シナリオの例
**シナリオ #1：** 安全でない直接オブジェクト参照<br>
  ユーザは、アクターのIDとoAuthベアラートークンを含めて、バックエンドREST APIに対してAPIエンドポイントリクエストを作成します。ユーザは、URLの一部にアクターのIDを含め、リクエストの標準ヘッダーにアクセストークを含めます。バックエンドはベアラートークンの存在は検証しますが、ベアラートークンに紐づくアクターIDの検証はしません。その結果、ユーザはアクターIDに手を加えREST APIリクエストの一部として、他ユーザのアカウント情報を手に入れることができます。

**シナリオ #2：** LDAPロールの送信<br>
  ユーザは、バックエンドREST APIに対して、ユーザが所属するLDAPグループのリストを含むヘッダと、標準のoAuthベアラートークンを含むAPIエンドポイントリクエストを作成します。バックエンドリクエストは、機密機能を実行する前に、ベアラートークンを検証し、受信するLDAPグループが正当なグループメンバーシップかどうかを検査します。しかしながら、バックエンドシステムはLDAPグループメンバーシップの検証を独立して実行せず、その代わりにユーザから来るLDAP情報を信頼します。ユーザは、受信するヘッダに手を加え任意のLDAPグループのメンバーであると報告して、管理者機能を実行します。


## 参考資料
### OWASP
 - [こちらを参照](https://www.owasp.org/)

### その他 
 - [外部参照](http://cwe.mitre.org/)
